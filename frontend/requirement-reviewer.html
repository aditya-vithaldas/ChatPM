<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requirement Reviewer - DecisionOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Merriweather:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #818cf8;
            --accent: #f97316; --accent-light: #fb923c;
            --bg-dark: #0f172a; --bg-darker: #020617;
            --text-primary: #f8fafc; --text-secondary: #94a3b8; --text-muted: #64748b;
            --success: #22c55e; --error: #ef4444; --warning: #f59e0b;
            --card-bg: rgba(255, 255, 255, 0.03);
            --border-color: rgba(255, 255, 255, 0.1);
            --cfo-color: #3b82f6;
            --ceo-color: #8b5cf6;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 40px 24px; }

        /* Header */
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 48px; }
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; }
        .logo-icon {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, #f97316 0%, #ec4899 100%);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 16px rgba(249, 115, 22, 0.3);
        }
        .logo-text { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1.5rem; font-weight: 800; color: white; }
        .back-link { color: var(--text-secondary); text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .back-link:hover { color: white; }

        /* Page Title */
        .page-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 2.5rem; font-weight: 800; margin-bottom: 12px;
            background: linear-gradient(135deg, #ffffff 0%, #c7d2fe 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .page-subtitle { color: var(--text-secondary); font-size: 1.1rem; margin-bottom: 24px; }

        /* Review Actions - Now at top */
        .review-actions-top {
            display: flex; gap: 12px; margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .review-btn-wrapper {
            position: relative;
        }
        .review-btn {
            padding: 14px 28px;
            border: none; border-radius: 12px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 0.95rem; font-weight: 700;
            cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .review-btn:hover { transform: translateY(-2px); }
        .review-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* Tooltip for review buttons */
        .review-tooltip {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            width: 300px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }
        .review-btn-wrapper:hover .review-tooltip {
            opacity: 1;
            visibility: visible;
        }
        .tooltip-title {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: white;
        }
        .tooltip-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .tooltip-list li {
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 4px 0;
            padding-left: 16px;
            position: relative;
        }
        .tooltip-list li::before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: var(--primary);
        }
        .tooltip-cfo li::before { color: var(--cfo-color); }
        .tooltip-ceo li::before { color: var(--ceo-color); }

        .review-btn.cfo {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        .review-btn.cfo:hover { box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4); }

        .review-btn.ceo {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
        }
        .review-btn.ceo:hover { box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4); }

        .review-btn.clear {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }
        .review-btn.clear:hover { border-color: var(--text-secondary); color: white; }

        .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 24px;
        }
        @media (max-width: 1024px) {
            .main-layout { grid-template-columns: 1fr; }
            .comments-panel { display: none; }
        }

        /* Editor Section */
        .editor-section {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 20px; overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            display: flex; flex-wrap: wrap; gap: 8px; padding: 16px 20px;
            background: rgba(0, 0, 0, 0.2); border-bottom: 1px solid var(--border-color);
            align-items: center;
        }
        .toolbar-group {
            display: flex; gap: 4px; padding-right: 12px;
            border-right: 1px solid var(--border-color);
        }
        .toolbar-group:last-child { border-right: none; padding-right: 0; }

        .toolbar-btn {
            width: 36px; height: 36px;
            background: transparent; border: 1px solid transparent;
            border-radius: 8px; color: var(--text-secondary);
            cursor: pointer; font-size: 1rem;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .toolbar-btn:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .toolbar-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .toolbar-select {
            padding: 8px 12px; background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color); border-radius: 8px;
            color: var(--text-primary); font-size: 0.85rem;
            cursor: pointer; min-width: 120px;
        }
        .toolbar-select:focus { outline: none; border-color: var(--primary); }
        .toolbar-select option { background: #1e1b4b; color: white; }

        /* Editor */
        .editor-wrapper {
            padding: 32px;
            min-height: 600px;
            background: rgba(255, 255, 255, 0.02);
        }
        .editor {
            min-height: 500px;
            outline: none;
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.8;
        }
        .editor:empty::before {
            content: "Start typing your requirements here, or paste from Google Docs...";
            color: var(--text-muted);
        }
        .editor h1 { font-size: 2rem; font-weight: 700; margin: 1em 0 0.5em; color: white; }
        .editor h2 { font-size: 1.5rem; font-weight: 600; margin: 1em 0 0.5em; color: white; }
        .editor h3 { font-size: 1.25rem; font-weight: 600; margin: 1em 0 0.5em; color: white; }
        .editor p { margin: 0.5em 0; }
        .editor ul, .editor ol { margin: 0.5em 0 0.5em 1.5em; }
        .editor li { margin: 0.25em 0; }

        /* Highlighted text with comment */
        .comment-highlight {
            background: rgba(59, 130, 246, 0.3);
            border-bottom: 2px solid var(--cfo-color);
            cursor: pointer;
            position: relative;
        }
        .comment-highlight.ceo {
            background: rgba(139, 92, 246, 0.3);
            border-bottom-color: var(--ceo-color);
        }
        .comment-highlight:hover {
            background: rgba(59, 130, 246, 0.5);
        }
        .comment-highlight.ceo:hover {
            background: rgba(139, 92, 246, 0.5);
        }
        .comment-highlight.resolved {
            background: rgba(34, 197, 94, 0.2);
            border-bottom-color: var(--success);
            opacity: 0.7;
        }

        /* Comments Panel */
        .comments-panel {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 24px;
            height: fit-content;
            position: sticky; top: 24px;
            max-height: calc(100vh - 48px);
            overflow-y: auto;
        }
        .comments-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 20px;
        }
        .comments-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1.1rem; font-weight: 700;
        }
        .comments-stats {
            display: flex; gap: 8px;
        }
        .comments-count {
            background: var(--primary);
            padding: 4px 10px; border-radius: 20px;
            font-size: 0.75rem; font-weight: 600;
        }
        .comments-count.resolved {
            background: var(--success);
        }
        .comments-list { display: flex; flex-direction: column; gap: 16px; }

        .comment-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px; padding: 16px;
            border-left: 3px solid var(--cfo-color);
            cursor: pointer; transition: all 0.2s;
        }
        .comment-card:hover { background: rgba(0, 0, 0, 0.3); }
        .comment-card.ceo { border-left-color: var(--ceo-color); }
        .comment-card.resolved {
            border-left-color: var(--success);
            opacity: 0.7;
        }
        .comment-card.resolved .comment-text,
        .comment-card.resolved .comment-excerpt {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .comment-author {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 8px;
        }
        .comment-avatar {
            width: 28px; height: 28px;
            border-radius: 50%; display: flex;
            align-items: center; justify-content: center;
            font-size: 14px;
        }
        .comment-avatar.cfo { background: var(--cfo-color); }
        .comment-avatar.ceo { background: var(--ceo-color); }
        .comment-avatar.resolved { background: var(--success); }

        .comment-name { font-weight: 600; font-size: 0.9rem; }
        .comment-role { color: var(--text-muted); font-size: 0.75rem; }
        .resolved-badge {
            background: var(--success);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: auto;
        }

        .comment-excerpt {
            font-size: 0.85rem; color: var(--text-secondary);
            margin-bottom: 8px;
            display: -webkit-box; -webkit-line-clamp: 2;
            -webkit-box-orient: vertical; overflow: hidden;
        }
        .comment-text {
            font-size: 0.9rem; color: var(--text-primary);
            line-height: 1.5;
        }

        .no-comments {
            text-align: center; padding: 40px 20px;
            color: var(--text-muted);
        }
        .no-comments-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }

        /* Loading Overlay */
        .loading-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); z-index: 1000;
            align-items: center; justify-content: center; flex-direction: column; gap: 16px;
        }
        .loading-overlay.visible { display: flex; }
        .loading-text { color: white; font-size: 1.1rem; }

        /* Feedback Button */
        .feedback-btn {
            position: fixed; bottom: 24px; right: 24px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none; border-radius: 50px; padding: 12px 20px;
            color: white; font-size: 0.9rem; font-weight: 600;
            cursor: pointer; box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
            display: flex; align-items: center; gap: 8px;
            transition: all 0.3s; z-index: 100;
        }
        .feedback-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5); }

        /* Feedback Modal */
        .feedback-modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8); z-index: 1000;
            align-items: center; justify-content: center; padding: 24px;
        }
        .feedback-modal.visible { display: flex; }
        .feedback-content {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            border: 1px solid var(--border-color); border-radius: 20px;
            padding: 32px; max-width: 500px; width: 100%;
        }
        .feedback-title { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1.5rem; font-weight: 700; margin-bottom: 8px; }
        .feedback-subtitle { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 24px; }
        .feedback-textarea {
            width: 100%; min-height: 150px; padding: 16px;
            background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border-color);
            border-radius: 12px; color: white; font-family: inherit; font-size: 0.95rem;
            resize: vertical; margin-bottom: 16px;
        }
        .feedback-textarea::placeholder { color: var(--text-muted); }
        .feedback-textarea:focus { outline: none; border-color: var(--primary); }
        .feedback-actions { display: flex; gap: 12px; justify-content: flex-end; }
        .feedback-cancel {
            padding: 10px 20px; background: transparent; border: 1px solid var(--border-color);
            border-radius: 8px; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem;
        }
        .feedback-cancel:hover { border-color: var(--text-secondary); color: white; }
        .feedback-submit {
            padding: 10px 20px; background: var(--primary); border: none;
            border-radius: 8px; color: white; cursor: pointer; font-size: 0.9rem; font-weight: 600;
        }
        .feedback-submit:hover { background: var(--primary-dark); }
        .feedback-submit:disabled { opacity: 0.6; cursor: not-allowed; }
        .feedback-success { color: var(--success); text-align: center; padding: 20px; font-size: 1.1rem; }

        /* Comment Popover */
        .comment-popover {
            display: none;
            position: absolute;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            width: 300px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 500;
        }
        .comment-popover.visible { display: block; }
        .comment-popover::before {
            content: '';
            position: absolute;
            top: -8px; left: 20px;
            width: 16px; height: 16px;
            background: #1e293b;
            border-left: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
            transform: rotate(45deg);
        }
        .popover-header {
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 12px;
        }
        .popover-avatar {
            width: 32px; height: 32px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
        }
        .popover-avatar.cfo { background: var(--cfo-color); }
        .popover-avatar.ceo { background: var(--ceo-color); }
        .popover-name { font-weight: 600; font-size: 0.95rem; }
        .popover-role { color: var(--text-muted); font-size: 0.75rem; }
        .popover-text { font-size: 0.9rem; line-height: 1.6; color: var(--text-primary); }
        .popover-close {
            position: absolute; top: 8px; right: 8px;
            background: transparent; border: none;
            color: var(--text-muted); cursor: pointer;
            font-size: 1rem; padding: 4px;
        }
        .popover-close:hover { color: white; }
        .popover-resolved {
            display: flex; align-items: center; gap: 6px;
            color: var(--success); font-size: 0.85rem;
            margin-top: 12px; padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <a href="/" class="logo">
                <span class="logo-icon">üìã</span>
                <span class="logo-text">DecisionOS</span>
            </a>
            <a href="/" class="back-link">‚Üê Back to Home</a>
        </header>

        <!-- Page Title -->
        <h1 class="page-title">Requirement Reviewer</h1>
        <p class="page-subtitle">Write or paste your requirements document, then get executive-level feedback with AI-powered review.</p>

        <!-- Review Actions - Now at top -->
        <div class="review-actions-top">
            <div class="review-btn-wrapper">
                <button class="review-btn cfo" id="cfo-btn" onclick="reviewByExecutive('cfo')">
                    <span id="cfo-btn-text">üíº Review by CFO</span>
                    <span class="spinner" id="cfo-spinner" style="display:none"></span>
                </button>
                <div class="review-tooltip">
                    <div class="tooltip-title">CFO Evaluation Criteria</div>
                    <ul class="tooltip-list tooltip-cfo">
                        <li>Clear measurable objective</li>
                        <li>Quantified expected outcome</li>
                        <li>Monetary value attached</li>
                        <li>Total cost estimate (dev + maintenance)</li>
                        <li>2-year ROI payback required</li>
                    </ul>
                </div>
            </div>
            <div class="review-btn-wrapper">
                <button class="review-btn ceo" id="ceo-btn" onclick="reviewByExecutive('ceo')">
                    <span id="ceo-btn-text">üëî Review by CEO</span>
                    <span class="spinner" id="ceo-spinner" style="display:none"></span>
                </button>
                <div class="review-tooltip">
                    <div class="tooltip-title">CEO Evaluation Criteria</div>
                    <ul class="tooltip-list tooltip-ceo">
                        <li>NPS improvement (65 ‚Üí 70)</li>
                        <li>Platform extensibility for new business</li>
                        <li>Core competence & IP development</li>
                    </ul>
                </div>
            </div>
            <button class="review-btn clear" onclick="clearComments()">
                Clear All Comments
            </button>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Editor Section -->
            <div class="editor-section">
                <!-- Toolbar -->
                <div class="toolbar">
                    <div class="toolbar-group">
                        <select class="toolbar-select" id="font-family" onchange="applyFontFamily()">
                            <option value="Inter">Inter</option>
                            <option value="Plus Jakarta Sans">Jakarta Sans</option>
                            <option value="Merriweather">Merriweather</option>
                            <option value="Roboto Mono">Roboto Mono</option>
                        </select>
                    </div>
                    <div class="toolbar-group">
                        <select class="toolbar-select" id="font-size" onchange="applyFontSize()" style="min-width: 80px;">
                            <option value="12px">12</option>
                            <option value="14px">14</option>
                            <option value="16px" selected>16</option>
                            <option value="18px">18</option>
                            <option value="20px">20</option>
                            <option value="24px">24</option>
                        </select>
                    </div>
                    <div class="toolbar-group">
                        <select class="toolbar-select" id="heading" onchange="applyHeading()" style="min-width: 100px;">
                            <option value="p">Normal</option>
                            <option value="h1">Heading 1</option>
                            <option value="h2">Heading 2</option>
                            <option value="h3">Heading 3</option>
                        </select>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" onclick="execCommand('bold')" title="Bold"><b>B</b></button>
                        <button class="toolbar-btn" onclick="execCommand('italic')" title="Italic"><i>I</i></button>
                        <button class="toolbar-btn" onclick="execCommand('underline')" title="Underline"><u>U</u></button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" onclick="execCommand('insertUnorderedList')" title="Bullet List">‚Ä¢</button>
                        <button class="toolbar-btn" onclick="execCommand('insertOrderedList')" title="Numbered List">1.</button>
                    </div>
                </div>

                <!-- Editor -->
                <div class="editor-wrapper">
                    <div class="editor" id="editor" contenteditable="true"><h2 style="color: #f8fafc;">The Problem Statement</h2><p style="color: #e2e8f0;">40% of users seem to be dropping off on the checkout page. User feedback has so far called out that it is mainly due to the lack of clarity, both in terms of delivery fee and also final discount provided.</p><h2 style="color: #f8fafc;">The Solution</h2><p style="color: #e2e8f0;">Ensure that all information that is entered by the user reaches the checkout page is provided specifically the delivery fee, the final price to be paid. If you want to collect all information in the previous step around the buyer's PIN code so that you can use it as a reference point for shipping cost calculation.</p><h2 style="color: #f8fafc;">The Benefit</h2><p style="color: #e2e8f0;">We are expecting the conversion rate to go up from 60% to 65% as a part of this. This would lead to a top-line improvement of 2 million euros.</p></div>
                </div>
            </div>

            <!-- Comments Panel -->
            <div class="comments-panel">
                <div class="comments-header">
                    <h3 class="comments-title">Comments</h3>
                    <div class="comments-stats">
                        <span class="comments-count" id="comments-count-open">0 open</span>
                        <span class="comments-count resolved" id="comments-count-resolved">0 resolved</span>
                    </div>
                </div>
                <div class="comments-list" id="comments-list">
                    <div class="no-comments">
                        <div class="no-comments-icon">üí¨</div>
                        <p>No comments yet</p>
                        <p style="font-size: 0.8rem; margin-top: 8px;">Click "Review by CFO" or "Review by CEO" to get executive feedback</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comment Popover -->
    <div class="comment-popover" id="comment-popover">
        <button class="popover-close" onclick="closePopover()">√ó</button>
        <div class="popover-header">
            <div class="popover-avatar cfo" id="popover-avatar">üíº</div>
            <div>
                <div class="popover-name" id="popover-name">CFO</div>
                <div class="popover-role" id="popover-role">Chief Financial Officer</div>
            </div>
        </div>
        <div class="popover-text" id="popover-text"></div>
        <div class="popover-resolved" id="popover-resolved" style="display:none">
            ‚úì This concern has been addressed
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner" style="width:40px;height:40px;border-width:3px"></div>
        <div class="loading-text" id="loading-text">Analyzing document...</div>
    </div>

    <!-- Feedback Button -->
    <button class="feedback-btn" onclick="openFeedback()">üí¨ Feedback</button>

    <!-- Feedback Modal -->
    <div class="feedback-modal" id="feedback-modal" onclick="if(event.target===this)closeFeedback()">
        <div class="feedback-content">
            <div id="feedback-form">
                <h3 class="feedback-title">Share Your Feedback</h3>
                <p class="feedback-subtitle">Help us improve! Tell us what you think about this tool.</p>
                <textarea class="feedback-textarea" id="feedback-text" placeholder="What's working well? What could be better? Any feature requests?"></textarea>
                <div class="feedback-actions">
                    <button class="feedback-cancel" onclick="closeFeedback()">Cancel</button>
                    <button class="feedback-submit" id="feedback-submit-btn" onclick="submitFeedback()">Submit</button>
                </div>
            </div>
            <div id="feedback-success" class="feedback-success" style="display:none">
                ‚úì Thank you for your feedback!
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let comments = [];
        let commentIdCounter = 0;

        // Editor commands
        function execCommand(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('editor').focus();
        }

        function applyFontFamily() {
            const font = document.getElementById('font-family').value;
            document.execCommand('fontName', false, font);
            document.getElementById('editor').focus();
        }

        function applyFontSize() {
            const size = document.getElementById('font-size').value;
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.style.fontSize = size;
                range.surroundContents(span);
            }
            document.getElementById('editor').focus();
        }

        function applyHeading() {
            const heading = document.getElementById('heading').value;
            document.execCommand('formatBlock', false, heading);
            document.getElementById('editor').focus();
        }

        // Clear all comments
        function clearComments() {
            comments = [];
            updateCommentsPanel();

            // Remove all highlights from editor
            const editor = document.getElementById('editor');
            const highlights = editor.querySelectorAll('.comment-highlight');
            highlights.forEach(highlight => {
                const parent = highlight.parentNode;
                while (highlight.firstChild) {
                    parent.insertBefore(highlight.firstChild, highlight);
                }
                parent.removeChild(highlight);
            });
        }

        // Review by Executive (CFO or CEO)
        async function reviewByExecutive(reviewer) {
            const editor = document.getElementById('editor');
            const content = editor.innerText.trim();

            if (!content) {
                alert('Please enter some requirements to review');
                return;
            }

            const btn = document.getElementById(`${reviewer}-btn`);
            const btnText = document.getElementById(`${reviewer}-btn-text`);
            const spinner = document.getElementById(`${reviewer}-spinner`);
            const loading = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');

            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'inline-block';
            loading.classList.add('visible');

            const reviewerName = reviewer === 'cfo' ? 'CFO' : 'CEO';
            const isReReview = comments.filter(c => c.reviewer === reviewer && !c.resolved).length > 0;

            if (isReReview) {
                loadingText.textContent = `${reviewerName} is re-reviewing and checking resolved items...`;
            } else {
                loadingText.textContent = `${reviewerName} is reviewing your requirements...`;
            }

            try {
                // Get existing comments for this reviewer to check for resolution
                const existingReviewerComments = comments
                    .filter(c => c.reviewer === reviewer && !c.resolved)
                    .map(c => ({ excerpt: c.excerpt, comment: c.comment }));

                const response = await fetch(`${API_BASE}/review-requirements`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        reviewer: reviewer,
                        existingComments: existingReviewerComments
                    })
                });

                const data = await response.json();

                if (data.error) {
                    alert(data.error);
                    return;
                }

                // Handle resolved comments
                if (data.resolvedComments && data.resolvedComments.length > 0) {
                    const unresolvedComments = comments.filter(c => c.reviewer === reviewer && !c.resolved);
                    data.resolvedComments.forEach(resolvedIndex => {
                        const idx = resolvedIndex - 1; // Convert 1-based to 0-based
                        if (unresolvedComments[idx]) {
                            const commentToResolve = comments.find(c =>
                                c.id === unresolvedComments[idx].id
                            );
                            if (commentToResolve) {
                                commentToResolve.resolved = true;
                                // Update highlight in editor
                                const highlight = document.querySelector(`[data-comment-id="${commentToResolve.id}"]`);
                                if (highlight) {
                                    highlight.classList.add('resolved');
                                }
                            }
                        }
                    });
                }

                // Add new comments to the document
                if (data.comments && data.comments.length > 0) {
                    addCommentsToDocument(data.comments, reviewer);
                }

                updateCommentsPanel();

            } catch (error) {
                console.error('Review error:', error);
                alert(`Failed to get ${reviewerName} review. Please try again.`);
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline';
                spinner.style.display = 'none';
                loading.classList.remove('visible');
            }
        }

        // Add comments to the document
        function addCommentsToDocument(newComments, reviewer) {
            const editor = document.getElementById('editor');

            newComments.forEach(comment => {
                // Check if this comment already exists (avoid duplicates)
                const isDuplicate = comments.some(c =>
                    c.reviewer === reviewer &&
                    c.excerpt.toLowerCase().substring(0, 30) === comment.excerpt.toLowerCase().substring(0, 30)
                );

                if (isDuplicate) return;

                const commentId = ++commentIdCounter;
                const commentObj = {
                    id: commentId,
                    reviewer: reviewer,
                    excerpt: comment.excerpt,
                    comment: comment.comment,
                    position: comment.position || 0,
                    resolved: false
                };
                comments.push(commentObj);

                // Try to find and highlight the excerpt in the editor
                if (comment.excerpt && comment.excerpt.length > 10) {
                    highlightExcerpt(comment.excerpt, commentId, reviewer);
                }
            });
        }

        // Highlight excerpt in editor
        function highlightExcerpt(excerpt, commentId, reviewer) {
            const editor = document.getElementById('editor');
            const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null, false);

            let node;
            while (node = walker.nextNode()) {
                const text = node.textContent;
                const index = text.toLowerCase().indexOf(excerpt.toLowerCase().substring(0, 50));

                if (index !== -1) {
                    let matchLength = 50;
                    for (let i = 50; i <= excerpt.length && i <= text.length - index; i++) {
                        if (text.substring(index, index + i).toLowerCase() === excerpt.substring(0, i).toLowerCase()) {
                            matchLength = i;
                        }
                    }

                    const range = document.createRange();
                    range.setStart(node, index);
                    range.setEnd(node, Math.min(index + matchLength, text.length));

                    const highlight = document.createElement('span');
                    highlight.className = `comment-highlight ${reviewer}`;
                    highlight.dataset.commentId = commentId;
                    highlight.onclick = (e) => showPopover(e, commentId);

                    try {
                        range.surroundContents(highlight);
                    } catch (e) {
                        console.log('Could not highlight:', excerpt.substring(0, 30));
                    }
                    break;
                }
            }
        }

        // Update comments panel
        function updateCommentsPanel() {
            const list = document.getElementById('comments-list');
            const countOpen = document.getElementById('comments-count-open');
            const countResolved = document.getElementById('comments-count-resolved');

            const openComments = comments.filter(c => !c.resolved);
            const resolvedComments = comments.filter(c => c.resolved);

            countOpen.textContent = `${openComments.length} open`;
            countResolved.textContent = `${resolvedComments.length} resolved`;

            if (comments.length === 0) {
                list.innerHTML = `
                    <div class="no-comments">
                        <div class="no-comments-icon">üí¨</div>
                        <p>No comments yet</p>
                        <p style="font-size: 0.8rem; margin-top: 8px;">Click "Review by CFO" or "Review by CEO" to get executive feedback</p>
                    </div>
                `;
                return;
            }

            // Sort: open comments first, then resolved
            const sortedComments = [...openComments, ...resolvedComments];

            list.innerHTML = sortedComments.map(comment => {
                const isCFO = comment.reviewer === 'cfo';
                const icon = comment.resolved ? '‚úì' : (isCFO ? 'üíº' : 'üëî');
                const name = isCFO ? 'CFO' : 'CEO';
                const role = isCFO ? 'Chief Financial Officer' : 'Chief Executive Officer';
                const resolvedClass = comment.resolved ? 'resolved' : '';
                const avatarClass = comment.resolved ? 'resolved' : comment.reviewer;

                return `
                    <div class="comment-card ${comment.reviewer} ${resolvedClass}" onclick="scrollToComment(${comment.id})">
                        <div class="comment-author">
                            <div class="comment-avatar ${avatarClass}">${icon}</div>
                            <div>
                                <div class="comment-name">${name}</div>
                                <div class="comment-role">${role}</div>
                            </div>
                            ${comment.resolved ? '<span class="resolved-badge">Resolved</span>' : ''}
                        </div>
                        <div class="comment-excerpt">"${escapeHtml(comment.excerpt.substring(0, 60))}..."</div>
                        <div class="comment-text">${escapeHtml(comment.comment)}</div>
                    </div>
                `;
            }).join('');
        }

        // Scroll to comment in editor
        function scrollToComment(commentId) {
            const highlight = document.querySelector(`[data-comment-id="${commentId}"]`);
            if (highlight) {
                highlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                highlight.style.animation = 'pulse 0.5s';
                setTimeout(() => highlight.style.animation = '', 500);
            }
        }

        // Show popover for comment
        function showPopover(event, commentId) {
            event.stopPropagation();
            const comment = comments.find(c => c.id === commentId);
            if (!comment) return;

            const popover = document.getElementById('comment-popover');
            const avatar = document.getElementById('popover-avatar');
            const name = document.getElementById('popover-name');
            const role = document.getElementById('popover-role');
            const text = document.getElementById('popover-text');
            const resolvedEl = document.getElementById('popover-resolved');

            const isCFO = comment.reviewer === 'cfo';
            avatar.className = `popover-avatar ${comment.reviewer}`;
            avatar.textContent = isCFO ? 'üíº' : 'üëî';
            name.textContent = isCFO ? 'CFO' : 'CEO';
            role.textContent = isCFO ? 'Chief Financial Officer' : 'Chief Executive Officer';
            text.textContent = comment.comment;

            if (comment.resolved) {
                text.style.textDecoration = 'line-through';
                text.style.color = 'var(--text-muted)';
                resolvedEl.style.display = 'flex';
            } else {
                text.style.textDecoration = 'none';
                text.style.color = 'var(--text-primary)';
                resolvedEl.style.display = 'none';
            }

            // Position popover near the clicked element
            const rect = event.target.getBoundingClientRect();
            popover.style.top = (rect.bottom + window.scrollY + 10) + 'px';
            popover.style.left = Math.max(10, rect.left + window.scrollX - 100) + 'px';
            popover.classList.add('visible');
        }

        function closePopover() {
            document.getElementById('comment-popover').classList.remove('visible');
        }

        // Close popover when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.comment-popover') && !e.target.closest('.comment-highlight')) {
                closePopover();
            }
        });

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Feedback functions
        function openFeedback() {
            document.getElementById('feedback-modal').classList.add('visible');
            document.getElementById('feedback-text').value = '';
            document.getElementById('feedback-form').style.display = 'block';
            document.getElementById('feedback-success').style.display = 'none';
        }

        function closeFeedback() {
            document.getElementById('feedback-modal').classList.remove('visible');
        }

        async function submitFeedback() {
            const text = document.getElementById('feedback-text').value.trim();
            if (!text) {
                alert('Please enter your feedback');
                return;
            }

            const btn = document.getElementById('feedback-submit-btn');
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page: 'requirement-reviewer',
                        feedback: text,
                        timestamp: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    document.getElementById('feedback-form').style.display = 'none';
                    document.getElementById('feedback-success').style.display = 'block';
                    setTimeout(closeFeedback, 2000);
                } else {
                    alert('Failed to submit feedback. Please try again.');
                }
            } catch (error) {
                console.error('Feedback error:', error);
                alert('Failed to submit feedback. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Submit';
            }
        }

        // Add pulse animation for highlighting
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { background: rgba(59, 130, 246, 0.3); }
                50% { background: rgba(59, 130, 246, 0.6); }
                100% { background: rgba(59, 130, 246, 0.3); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
