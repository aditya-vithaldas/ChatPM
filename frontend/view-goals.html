<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Goals View - DecisionOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --strategy-color: #8b5cf6;
            --goal-color: #3b82f6;
            --requirement-color: #f97316;
            --metric-color: #22c55e;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
        }

        .header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 60px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
        }

        .header-left { display: flex; align-items: center; gap: 16px; }
        .back-btn {
            background: none; border: none;
            color: var(--text-secondary);
            font-size: 1.5rem; cursor: pointer;
            padding: 8px; border-radius: 8px;
            transition: all 0.2s;
        }
        .back-btn:hover { background: var(--bg-card); color: var(--text-primary); }
        .header-title { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1.25rem; font-weight: 700; }

        .level-indicator {
            display: flex; align-items: center; gap: 4px;
            background: var(--bg-card); padding: 6px 12px; border-radius: 20px;
        }
        .level-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--border-color); cursor: pointer; transition: all 0.3s;
        }
        .level-dot.active { transform: scale(1.3); }
        .level-dot.strategy { background: var(--strategy-color); }
        .level-dot.goal { background: var(--goal-color); }
        .level-dot.requirement { background: var(--requirement-color); }
        .level-dot.metric { background: var(--metric-color); }

        .header-right { display: flex; align-items: center; gap: 12px; }
        .zoom-btn {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 20px; border-radius: 25px; border: none;
            font-size: 0.9rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .zoom-in-btn { background: linear-gradient(135deg, var(--requirement-color), #f59e0b); color: white; }
        .zoom-out-btn { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color); }
        .zoom-btn:hover { transform: scale(1.05); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }

        /* Strategy Title Header */
        .strategy-header {
            position: fixed;
            top: 60px; left: 0; right: 0;
            height: 70px;
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.95));
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 40px;
            gap: 16px;
            z-index: 90;
        }

        .strategy-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(139, 92, 246, 0.1));
            border: 2px solid var(--strategy-color);
            font-size: 1.2rem;
        }

        .strategy-header-content {
            flex: 1;
        }

        .strategy-header-label {
            font-size: 0.7rem;
            color: var(--strategy-color);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        .strategy-header-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Strategic Context Panel */
        .strategy-context {
            position: fixed;
            top: 130px;
            left: 0;
            right: 0;
            height: 120px;
            background: linear-gradient(180deg, var(--bg-main), rgba(15, 23, 42, 0.95));
            border-bottom: 1px solid var(--border-color);
            padding: 12px 40px;
            display: flex;
            gap: 20px;
            z-index: 80;
            overflow-x: auto;
        }

        /* Strategy Write-up Section */
        .strategy-writeup {
            position: fixed;
            top: 250px;
            left: 0;
            right: 0;
            background: var(--bg-main);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 40px;
            z-index: 75;
        }

        .writeup-content {
            max-width: 1000px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .writeup-content strong {
            color: var(--text-primary);
        }

        .context-card {
            flex: 0 0 auto;
            min-width: 280px;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 14px 18px;
            border: 1px solid var(--border-color);
        }

        .context-card.strategy-summary {
            min-width: 320px;
            border-color: rgba(139, 92, 246, 0.3);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05));
        }

        .context-card.competitive {
            border-color: rgba(249, 115, 22, 0.3);
        }

        .context-card.customer {
            border-color: rgba(59, 130, 246, 0.3);
        }

        .context-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .context-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .context-icon.strategy { background: rgba(139, 92, 246, 0.2); color: var(--strategy-color); }
        .context-icon.competitive { background: rgba(249, 115, 22, 0.2); color: var(--requirement-color); }
        .context-icon.customer { background: rgba(59, 130, 246, 0.2); color: var(--goal-color); }

        .context-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .context-content {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .context-highlight {
            font-weight: 600;
            color: var(--text-primary);
        }

        .context-metrics {
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }

        .context-metric {
            text-align: center;
        }

        .context-metric-value {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1rem;
            font-weight: 700;
        }

        .context-metric-value.positive { color: var(--success); }
        .context-metric-value.negative { color: var(--error); }

        .context-metric-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .competitive-rank {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rank-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .rank-badge.first { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #0f172a; }
        .rank-badge.second { background: linear-gradient(135deg, #94a3b8, #64748b); color: #0f172a; }
        .rank-badge.third { background: linear-gradient(135deg, #cd7f32, #8b5a2b); color: white; }
        .rank-badge.other { background: var(--bg-main); color: var(--text-secondary); }

        .rank-details {
            flex: 1;
        }

        .rank-position {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .rank-trend {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .customer-quote {
            font-style: italic;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .customer-source {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .sentiment-badge {
            display: inline-block;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
            margin-left: 8px;
        }

        .sentiment-badge.positive { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .sentiment-badge.neutral { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

        .main-container {
            position: fixed;
            top: 340px; left: 0; right: 0; bottom: 0;
            overflow: hidden;
            perspective: 2000px;
        }

        .view-container {
            width: 100%; height: 100%;
            transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }

        .view-container.zooming-out {
            transform: scale(0.5) translateZ(-500px);
            opacity: 0;
        }

        .view-container.drilling-in {
            transform: scale(3) translateZ(500px);
            opacity: 0;
        }

        .content-scroll {
            width: 100%; height: 100%;
            overflow-x: auto; overflow-y: hidden;
            display: flex; align-items: center;
            padding: 30px 40px;
            gap: 24px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }

        /* Goal Card */
        .goal-card {
            flex: 0 0 360px;
            height: calc(100% - 60px);
            max-height: 500px;
            background: linear-gradient(145deg, var(--bg-card), #252f3f);
            border-radius: 24px;
            border: 1px solid var(--border-color);
            padding: 24px;
            scroll-snap-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
        }

        .goal-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--goal-color), #06b6d4);
        }

        .goal-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 80px rgba(59, 130, 246, 0.25);
            border-color: var(--goal-color);
        }

        .goal-card.selected {
            border-color: var(--goal-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4), 0 25px 80px rgba(59, 130, 246, 0.3);
            transform: scale(1.02);
        }

        .goal-card.drilling {
            transform: scale(1.5) translateZ(200px);
            z-index: 1000;
            box-shadow: 0 0 100px rgba(59, 130, 246, 0.5);
        }

        .card-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 14px; border-radius: 20px;
            font-size: 0.7rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.05em;
            margin-bottom: 12px; width: fit-content;
        }
        .card-badge.goal { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }

        .card-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1.2rem; font-weight: 700;
            line-height: 1.3; margin-bottom: 8px;
        }

        .card-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 12px;
            flex: 1;
            overflow: hidden;
        }

        .value-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .value-box {
            background: var(--bg-main);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .value-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 2px;
        }

        .value-amount {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 0.95rem;
            font-weight: 700;
        }

        .value-amount.upside { color: var(--success); }
        .value-amount.cost { color: var(--error); }

        .progress-section { margin-top: auto; }

        .coverage-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 8px;
        }

        .coverage-item {
            background: var(--bg-main);
            border-radius: 10px;
            padding: 10px 12px;
        }

        .coverage-item.actual {
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .coverage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .coverage-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .coverage-value {
            font-size: 0.85rem;
            font-weight: 700;
        }

        .coverage-value.green { color: var(--success); }
        .coverage-value.amber { color: var(--warning); }
        .coverage-value.red { color: var(--error); }

        .progress-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 6px;
        }
        .progress-label { font-size: 0.7rem; color: var(--text-muted); }
        .progress-value { font-size: 0.9rem; font-weight: 700; }
        .progress-value.green { color: var(--success); }
        .progress-value.amber { color: var(--warning); }
        .progress-value.red { color: var(--error); }

        .progress-bar {
            height: 6px;
            background: var(--bg-main);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .progress-fill.green { background: linear-gradient(90deg, var(--success), #4ade80); }
        .progress-fill.amber { background: linear-gradient(90deg, var(--warning), #fbbf24); }
        .progress-fill.red { background: linear-gradient(90deg, var(--error), #f87171); }

        .coverage-comparison {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            margin-top: 6px;
        }

        .coverage-delta {
            font-weight: 600;
        }

        .coverage-delta.positive { color: var(--success); }
        .coverage-delta.negative { color: var(--error); }

        .requirements-count {
            display: flex; align-items: center; gap: 8px;
            margin-top: 12px; padding: 10px 12px;
            background: rgba(249, 115, 22, 0.1);
            border-radius: 8px;
            color: var(--requirement-color);
            font-size: 0.8rem; font-weight: 500;
        }


        .zoom-hint {
            position: fixed;
            bottom: 30px; left: calc(50% - 150px);
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            padding: 14px 28px; border-radius: 30px;
            font-size: 0.9rem; color: var(--text-secondary);
            display: flex; align-items: center; gap: 12px;
            z-index: 50;
            border: 1px solid var(--border-color);
        }

        @media (max-width: 768px) {
            .goal-card { flex: 0 0 300px; }
            .header-center { display: none; }
            .strategy-header { padding: 0 20px; height: 60px; }
            .strategy-header-title { font-size: 1.1rem; }
            .strategy-context { padding: 10px 20px; height: 100px; top: 120px; }
            .strategy-writeup { top: 220px; padding: 15px 20px; }
            .main-container { top: 310px; }
            .context-card { min-width: 220px; padding: 10px 14px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <button class="back-btn" onclick="zoomOut()">&#8592;</button>
            <div>
                <h1 class="header-title">Goals</h1>
            </div>
        </div>
        <div class="header-center">
            <div class="level-indicator">
                <div class="level-dot strategy" onclick="zoomOut()"></div>
                <div class="level-dot goal active"></div>
                <div class="level-dot requirement"></div>
                <div class="level-dot metric"></div>
            </div>
        </div>
        <div class="header-right">
            <button class="zoom-btn zoom-out-btn" onclick="zoomOut()">&#8722; Zoom Out</button>
            <button class="zoom-btn zoom-in-btn" onclick="zoomIn()">Zoom In &#43;</button>
        </div>
    </header>

    <!-- Strategy Title Header -->
    <div class="strategy-header" id="strategy-header">
        <!-- Populated by JS -->
    </div>

    <!-- Strategic Context Panel -->
    <div class="strategy-context" id="strategy-context">
        <!-- Populated by JS -->
    </div>

    <!-- Strategy Write-up -->
    <div class="strategy-writeup" id="strategy-writeup">
        <!-- Populated by JS -->
    </div>

    <main class="main-container">
        <div class="view-container" id="view-container">
            <div class="content-scroll" id="content-scroll"></div>
        </div>
    </main>

    <div class="zoom-hint">
        <span>&#128269;</span>
        <span>Select a goal and <strong>Zoom In</strong> for Requirements</span>
    </div>

    <script>
        const fullData = JSON.parse(localStorage.getItem('strategyMapData')) || { strategies: [] };
        const selectedStrategyId = sessionStorage.getItem('selectedStrategyId');
        let currentStrategy = fullData.strategies.find(s => s.id === selectedStrategyId) || fullData.strategies[0];
        let selectedGoal = null;

        // Customer feedback data for strategies
        const customerFeedback = {
            'str-1': { quote: 'Payment speeds have dramatically improved. This is exactly what we needed for our high-volume operations.', source: 'Fortune 500 Client', sentiment: 'positive' },
            'str-2': { quote: 'Having lending and payments in one place would save us significant time and operational costs.', source: 'Mid-Market Client', sentiment: 'positive' },
            'str-3': { quote: 'The 99.99% uptime target exceeds our requirements. Critical for our 24/7 operations.', source: 'Global Retailer', sentiment: 'positive' },
            'str-4': { quote: 'AI-powered insights have transformed how we understand customer behavior.', source: 'Marketing Director', sentiment: 'positive' }
        };

        // Competitive data for strategies
        const competitiveData = {
            'str-1': { position: 2, leader: 'Stripe', gap: '-15%', trend: 'Improving' },
            'str-2': { position: 3, leader: 'Square', gap: '-25%', trend: 'Growing' },
            'str-3': { position: 1, leader: 'Us', gap: '+8%', trend: 'Leading' },
            'str-4': { position: 4, leader: 'Visa', gap: '-30%', trend: 'Accelerating' }
        };

        // Strategy write-ups explaining what each strategy means
        const strategyWriteups = {
            'str-1': `<strong>Market Leadership in Digital Payments</strong> is our core growth engine. As commerce increasingly moves digital, capturing payment volume is essential for long-term revenue sustainability. This strategy focuses on expanding our merchant base, improving transaction speeds, and reducing processing costs to become the preferred payment partner for businesses of all sizes. Success here directly drives our top-line growth and creates the foundation for all other strategic initiatives.`,
            'str-2': `<strong>Financial Services Ecosystem</strong> represents our evolution beyond pure payments into a comprehensive financial platform. By offering lending, banking, and financial management tools alongside our payment infrastructure, we create deeper merchant relationships and multiple revenue streams. This strategy leverages our existing transaction data to underwrite loans more accurately and serve our merchants' broader financial needs, increasing customer lifetime value significantly.`,
            'str-3': `<strong>Global Infrastructure Scale</strong> is the technical backbone enabling all other strategies. World-class uptime and processing capacity aren't just operational metrics—they're competitive advantages. Enterprise clients require five-nines reliability, and our ability to scale to 100K transactions per second positions us to capture high-volume merchants that competitors cannot serve. Investment here reduces long-term operational costs while enabling premium pricing.`,
            'str-4': `<strong>AI-First Product Experience</strong> differentiates us in an increasingly commoditized market. By embedding machine learning into fraud detection, customer insights, and personalized recommendations, we deliver measurable value beyond basic payment processing. This strategy transforms us from a utility into a strategic partner, driving higher engagement and reducing churn through intelligent features that competitors struggle to replicate.`
        };

        function getProgressColor(p) { return p >= 80 ? 'green' : p >= 50 ? 'amber' : 'red'; }

        function renderStrategyHeader() {
            const header = document.getElementById('strategy-header');
            if (!currentStrategy) {
                header.innerHTML = '';
                return;
            }

            header.innerHTML = `
                <div class="strategy-badge">&#9733;</div>
                <div class="strategy-header-content">
                    <div class="strategy-header-label">Strategy</div>
                    <div class="strategy-header-title">${currentStrategy.title}</div>
                </div>
            `;
        }

        function renderStrategyWriteup() {
            const writeup = document.getElementById('strategy-writeup');
            if (!currentStrategy) {
                writeup.innerHTML = '';
                return;
            }

            const content = strategyWriteups[currentStrategy.id] || currentStrategy.description || 'No detailed description available for this strategy.';
            writeup.innerHTML = `<div class="writeup-content">${content}</div>`;
        }

        function renderStrategyContext() {
            const container = document.getElementById('strategy-context');
            if (!currentStrategy) {
                container.innerHTML = '';
                return;
            }

            const feedback = customerFeedback[currentStrategy.id] || { quote: 'No feedback yet', source: 'N/A', sentiment: 'neutral' };
            const competitive = competitiveData[currentStrategy.id] || { position: 4, leader: 'Unknown', gap: 'N/A', trend: 'N/A' };
            const rankClass = competitive.position === 1 ? 'first' : competitive.position === 2 ? 'second' : competitive.position === 3 ? 'third' : 'other';

            container.innerHTML = `
                <!-- Strategy Summary -->
                <div class="context-card strategy-summary">
                    <div class="context-header">
                        <span class="context-icon strategy">&#9733;</span>
                        <span class="context-title">Strategy Context</span>
                    </div>
                    <div class="context-content">
                        <span class="context-highlight">${currentStrategy.title}</span>
                    </div>
                    <div class="context-metrics">
                        <div class="context-metric">
                            <div class="context-metric-value positive">${currentStrategy.upside || 'TBD'}</div>
                            <div class="context-metric-label">Upside</div>
                        </div>
                        <div class="context-metric">
                            <div class="context-metric-value negative">${currentStrategy.cost || 'TBD'}</div>
                            <div class="context-metric-label">Investment</div>
                        </div>
                        <div class="context-metric">
                            <div class="context-metric-value">${currentStrategy.goals?.length || 0}</div>
                            <div class="context-metric-label">Goals</div>
                        </div>
                    </div>
                </div>

                <!-- Competitive Position -->
                <div class="context-card competitive">
                    <div class="context-header">
                        <span class="context-icon competitive">&#9876;</span>
                        <span class="context-title">Competitive Position</span>
                    </div>
                    <div class="competitive-rank">
                        <div class="rank-badge ${rankClass}">#${competitive.position}</div>
                        <div class="rank-details">
                            <div class="rank-position">${competitive.position === 1 ? 'Market Leader' : `${competitive.gap} vs ${competitive.leader}`}</div>
                            <div class="rank-trend">Trend: ${competitive.trend}</div>
                        </div>
                    </div>
                </div>

                <!-- Customer Feedback -->
                <div class="context-card customer">
                    <div class="context-header">
                        <span class="context-icon customer">&#128101;</span>
                        <span class="context-title">Customer Voice</span>
                        <span class="sentiment-badge ${feedback.sentiment}">${feedback.sentiment === 'positive' ? '&#128077;' : '&#128528;'}</span>
                    </div>
                    <div class="customer-quote">"${feedback.quote}"</div>
                    <div class="customer-source">— ${feedback.source}</div>
                </div>
            `;
        }

        function switchStrategy(id) {
            currentStrategy = fullData.strategies.find(s => s.id === id);
            sessionStorage.setItem('selectedStrategyId', id);
            selectedGoal = null;
            renderStrategyHeader();
            renderStrategyContext();
            renderStrategyWriteup();
            renderGoals();
        }

        function calculateGoalValue(goal) {
            let upside = 0, cost = 0;
            if (goal.initiatives) {
                goal.initiatives.forEach(i => {
                    const uMatch = i.upside?.match(/\$?([\d.]+)([BMK])?/);
                    if (uMatch) {
                        let val = parseFloat(uMatch[1]);
                        if (uMatch[2] === 'B') val *= 1000;
                        else if (uMatch[2] === 'K') val /= 1000;
                        upside += val;
                    }
                    const cMatch = i.downside?.match(/\$?([\d.]+)([BMK])?/);
                    if (cMatch) {
                        let val = parseFloat(cMatch[1]);
                        if (cMatch[2] === 'B') val *= 1000;
                        else if (cMatch[2] === 'K') val /= 1000;
                        cost += val;
                    }
                });
            }
            return {
                upside: upside > 0 ? (upside >= 1000 ? `$${(upside/1000).toFixed(1)}B` : `$${upside.toFixed(0)}M`) : goal.upside || 'TBD',
                cost: cost > 0 ? (cost >= 1000 ? `$${(cost/1000).toFixed(1)}B` : `$${cost.toFixed(0)}M`) : goal.cost || 'TBD'
            };
        }

        function calculateActualCoverage(goal) {
            // Calculate actual coverage based on requirements with metrics
            if (!goal.initiatives || goal.initiatives.length === 0) return 0;
            const withMetrics = goal.initiatives.filter(i => i.metrics && i.metrics.length > 0).length;
            return Math.round((withMetrics / goal.initiatives.length) * 100);
        }

        function renderGoals() {
            const container = document.getElementById('content-scroll');
            if (!currentStrategy?.goals) {
                container.innerHTML = '<div style="text-align:center;padding:60px;color:var(--text-muted);">No goals found</div>';
                return;
            }

            container.innerHTML = currentStrategy.goals.map(goal => {
                const plannedProgress = goal.targetProgress || 0;
                const actualProgress = goal.actualProgress || calculateActualCoverage(goal);
                const plannedColor = getProgressColor(plannedProgress);
                const actualColor = getProgressColor(actualProgress);
                const count = goal.initiatives?.length || 0;
                const values = calculateGoalValue(goal);
                const delta = actualProgress - plannedProgress;
                const deltaClass = delta >= 0 ? 'positive' : 'negative';

                return `
                    <div class="goal-card ${selectedGoal?.id === goal.id ? 'selected' : ''}"
                         data-id="${goal.id}"
                         onclick="selectGoal('${goal.id}')"
                         ondblclick="zoomIn()">
                        <span class="card-badge goal">&#127919; Goal</span>
                        <h2 class="card-title">${goal.title}</h2>
                        <p class="card-description">${goal.description || 'No description available'}</p>

                        <div class="value-section">
                            <div class="value-box">
                                <div class="value-label">Upside</div>
                                <div class="value-amount upside">${values.upside}</div>
                            </div>
                            <div class="value-box">
                                <div class="value-label">Cost</div>
                                <div class="value-amount cost">${values.cost}</div>
                            </div>
                        </div>

                        <div class="progress-section">
                            <div class="coverage-grid">
                                <div class="coverage-item">
                                    <div class="coverage-header">
                                        <span class="coverage-label">Planned</span>
                                        <span class="coverage-value ${plannedColor}">${plannedProgress}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill ${plannedColor}" style="width: ${plannedProgress}%"></div>
                                    </div>
                                </div>
                                <div class="coverage-item actual">
                                    <div class="coverage-header">
                                        <span class="coverage-label">Actual</span>
                                        <span class="coverage-value ${actualColor}">${actualProgress}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill ${actualColor}" style="width: ${actualProgress}%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="coverage-comparison">
                                <span style="color: var(--text-muted)">Delta:</span>
                                <span class="coverage-delta ${deltaClass}">${delta >= 0 ? '+' : ''}${delta}%</span>
                                <span style="color: var(--text-muted)">${delta >= 0 ? 'ahead of plan' : 'behind plan'}</span>
                            </div>
                        </div>

                        <div class="requirements-count">
                            <span>&#128640;</span>
                            <span>${count} Requirement${count !== 1 ? 's' : ''}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectGoal(id) {
            selectedGoal = currentStrategy.goals.find(g => g.id === id);
            sessionStorage.setItem('selectedGoalId', id);
            renderGoals();
        }

        function zoomIn() {
            if (!selectedGoal && currentStrategy.goals?.length > 0) {
                selectGoal(currentStrategy.goals[0].id);
            }
            if (selectedGoal) {
                const card = document.querySelector(`[data-id="${selectedGoal.id}"]`);
                if (card) card.classList.add('drilling');
                document.getElementById('view-container').classList.add('drilling-in');
                setTimeout(() => { window.location.href = 'view-requirements.html'; }, 500);
            }
        }

        function zoomOut() {
            document.getElementById('view-container').classList.add('zooming-out');
            setTimeout(() => { window.location.href = 'view-strategy.html'; }, 500);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); zoomIn(); }
            if (e.key === 'Escape' || e.key === 'Backspace') { e.preventDefault(); zoomOut(); }
            if (e.key === 'ArrowRight') navigateCard(1);
            if (e.key === 'ArrowLeft') navigateCard(-1);
        });

        function navigateCard(dir) {
            const goals = currentStrategy.goals || [];
            const idx = selectedGoal ? goals.findIndex(g => g.id === selectedGoal.id) : -1;
            const newIdx = Math.max(0, Math.min(goals.length - 1, idx + dir));
            selectGoal(goals[newIdx].id);
            document.querySelector(`[data-id="${goals[newIdx].id}"]`)?.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        }

        renderStrategyHeader();
        renderStrategyContext();
        renderStrategyWriteup();
        renderGoals();
        const savedGoalId = sessionStorage.getItem('selectedGoalId');
        if (savedGoalId && currentStrategy.goals?.find(g => g.id === savedGoalId)) selectGoal(savedGoalId);
    </script>
</body>
</html>
